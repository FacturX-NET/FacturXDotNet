name: Continuous Deployment - Publish alpha build

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha'
  workflow_dispatch:

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  
  compute-version:
    name: Compute Version
    uses: ./.github/workflows/reusable-compute-version.yml
  
  build-docker-image:
    name: Build Docker Image
    needs: compute-version
    uses: ./.github/workflows/reusable-build-publish-api-docker-image.yml
    with:
      tag: latest-alpha
      version: ${{ needs.compute-version.outputs.version }}
  
  build-editor-application:
    name: Build Editor Application
    needs: compute-version
    uses: ./.github/workflows/reusable-build-editor-application.yml
    with:
      artifact-name: editor
      version: ${{ needs.compute-version.outputs.version }}

  deploy:
    name: Deploy API and Editor to Production
    runs-on: ubuntu-latest
    needs:
      - build-docker-image
      - build-editor-application
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download editor artifact
        uses: actions/download-artifact@v4
        with:
          name: editor
          path: dist/editor

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/prod.key
          chmod 600 ~/.ssh/prod.key

          echo "Host prod"                               > ~/.ssh/config
          echo "  HostName ${{ secrets.PROD_SSH_HOST }}" >> ~/.ssh/config
          echo "  User ${{ secrets.PROD_SSH_USER }}"     >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/prod.key"          >> ~/.ssh/config
          echo "  StrictHostKeyChecking no"              >> ~/.ssh/config
      
      # START maintenance mode
      - name: Create temporary folder for this build
        run: |
          ssh prod 'mkdir -p ~/${{ github.run_id }}'

      - name: Start maintenance mode
        run: |
          scp .github/workflows/pages/maintenance.html prod:~/${{ github.run_id }}/maintenance.html
          ssh prod 'sudo mkdir -p /var/www/api-alpha.facturxdotnet.org/html'
          ssh prod 'sudo mkdir -p /var/www/editor-alpha.facturxdotnet.org/html'
          ssh prod 'sudo cp ~/${{ github.run_id }}/maintenance.html /var/www/api-alpha.facturxdotnet.org/html/maintenance.html'
          ssh prod 'sudo cp ~/${{ github.run_id }}/maintenance.html /var/www/editor-alpha.facturxdotnet.org/html/maintenance.html'

      # UPDATE applications
      - name: Pull new API image and restart application
        run: |
          ssh prod 'cd facturxdotnet/alpha; sed -i -e s/image: ${{ needs.build-docker-image.outputs.image_name }}:.*/image: ${{ needs.build-docker-image.outputs.image_name }}:latest-alpha/g'
          ssh prod 'cd facturxdotnet/alpha; docker compose pull'
          ssh prod 'cd facturxdotnet/alpha; docker compose up -d'

      - name: Replace current build of Editor application
        run: |
          ssh prod 'mkdir -p ~/${{ github.run_id }}/editor'
          scp -r dist/editor/* prod:~/${{ github.run_id }}/editor
          ssh prod 'sudo mkdir -p /var/www/editor-alpha.facturxdotnet.org/html'          
          ssh prod 'find /var/www/editor-alpha.facturxdotnet.org/html/ ! -name 'maintenance.html' -type f -exec rm -f {} +'
          ssh prod 'sudo cp ~/${{ github.run_id }}/editor/* /var/www/editor-alpha.facturxdotnet.org/html/'

      - name: Replace nginx configurations
        run: |
          ssh prod 'mkdir -p ~/${{ github.run_id }}/nginx'
          scp .github/workflows/configs/api-alpha.nginx.conf prod:~/${{ github.run_id }}/nginx/api-alpha.nginx.conf
          scp .github/workflows/configs/editor-alpha.nginx.conf prod:~/${{ github.run_id }}/nginx/editor-alpha.nginx.conf
          ssh prod 'sudo cp ~/${{ github.run_id }}/nginx/api-alpha.nginx.conf /etc/nginx/conf.d/api-alpha.facturxdotnet.org.conf'
          ssh prod 'sudo cp ~/${{ github.run_id }}/nginx/editor-alpha.nginx.conf /etc/nginx/conf.d/editor-alpha.facturxdotnet.org.conf'

      - name: Restart nginx
        run: |
          ssh prod 'sudo systemctl restart nginx'
      
      # EXIT maintenance mode
      - name: Exit maintenance mode
        run: |
          ssh prod 'sudo rm /var/www/api-alpha.facturxdotnet.org/html/maintenance.html'
          ssh prod 'sudo rm /var/www/editor-alpha.facturxdotnet.org/html/maintenance.html'

      - name: Remove temporary folder for this build
        if: always()
        run: |
          ssh prod 'rm -rf ~/${{ github.run_id }}'
